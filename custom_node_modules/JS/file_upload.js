'use strict';

const fs = require('fs');
const path = require('path');
const mimeTypes = require('../JSON/mime_types.json');

async function fileUpload(url, res) {
  // res.header('Access-Control-Allow-Origin', 'http://5.35.13.205');
  // res.header('Access-Control-Allow-Origin', 'http://blindprintingsimulator.ru');
  // res.header('Access-Control-Allow-Origin', 'https://blindprintingsimulator.ru');
  res.header('Access-Control-Allow-Origin', '*');
  res.header('mode', 'no-cors');
  res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
  res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization');
  res.header('Access-Control-Allow-Credentials', 'true');

  const ext = String(path.extname(url)).toLocaleLowerCase();
  console.log(url);

  if (!url.includes('public')) {
    console.log(`доступ запрещен`);
    res.setHeader('Content-Type', 'text/html; charset=utf-8');
    res.end(
      `<div>доступ запрещен. <a href="/public/HTML/main_page.html">Перейдте по ссылке на главную стриницу<a></div>`
    );
    return;
  }

  if (ext in mimeTypes) {
    res.setHeader('Content-Type', mimeTypes[ext]);

    fs.readFile(`.${url}`, (error, data) => {
      if (error) {
        console.log(`ошибка при чтении файла ${url}`);
        res.end();
        return;
      }

      res.end(data);
      return;
    });
  } else {
    console.log(`ошибка: расширения ${ext} нет в mimeTypes`);
    res.end();
  }
}

module.exports = fileUpload;
